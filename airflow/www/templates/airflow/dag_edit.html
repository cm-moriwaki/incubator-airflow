{% extends "airflow/dag.html" %}

{% block title %}
    {{ title }}
{% endblock %}

{% block head_css %}
{{ super() }}
{% endblock %}

{% block body %}
{{ super() }}
<form method="POST" action="{{ get_url("airflow.update_dag")}}" role="form" enctype="multipart/form-data" class="form-horizontal" id="editDagForm">
    <div class="form-group">
        <label class="col-md-2 control-label">タスク名</label>
        <div class="col-md-3">
            <input autofocus class="form-control" name="dag_id" type="text" value="{{ dag.dag_id }}" pattern="^[_A-z0-9]{1,}$" maxlength="30" required placeholder="task_xxx">
        </div>
        <span class="glyphicon glyphicon-info-sign" title="英数字，アンダースコアを30文字まで使用可能です"></span>
        <div class="help-block with-errors"></div>
    </div>
    <div class="form-group">
        <label class="col-md-2 control-label">スケジュール</label>
        <div class="col-md-2">
            <input class="form-control" name="schedule_interval" type="text" required value="{{ dag.schedule_interval_pp }}"  required placeholder="10:00:00" maxlength="14" pattern="^([0-9]{1,2},[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2})|([0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2})|([0-9]{1,3})|([0-9]{1,2}:[0-9]{1,2})|((Sun|SUN|sun|Mon|MON|mon|Tue|TUE|tue|Wed|WED|wed|Thu|THU|thu|Fri|FRI|fri|Sat|SAT|sat),[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2})$">
        </div>
        <span class="glyphicon glyphicon-info-sign" title="日次:[HH:MM:SS]&#x0A;毎時:[MM:SS]&#x0A;週次:[DDD,HH:MM:SS]&#x0A;月次:[D,HH:MM:SS]&#x0A;M分毎:[M]"></span>
        <div class="help-block with-errors"></div>
    </div>
    <hr>
<table class="table table-striped table-bordered condensed" id='table_info_raw'>
    <thead>
        <tr>
            <th>種別</span></th>
            <th>スキーマ <span class="glyphicon glyphicon-info-sign" title="省略時、publicスキーマ"></span></th>
            <th>テーブル(必須)</th>
            <th>ファイルprefix(必須)</th>
            <th>ソートキー <span class="glyphicon glyphicon-info-sign" title="行番号をカンマ区切りで入力。省略時、1列目をソートキー"></span></th>
            <th>分散スタイル <span class="glyphicon glyphicon-info-sign" title="all, even, または行番号を入力。省略時、最適なスタイルを自動付与"></span></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    {% if dag.csa_target_tables %}
    {% for target in dag.csa_target_tables %}
    <tr>
        <td class="row col-md-1">
            <div class="col-md-12">
                <div class="form-group">
                    <select class="form-control select_is_master" name="is_master" require>
                        <option {{ "selected" if target.is_master}}>全件</option>
                        <option {{ "selected" if not target.is_master}}>差分</option>
                    </select>
                </div>
            </div>
        </td>
        <td class="row col-md-1">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="schema_name" type="text" value="{{ target.schema_name }}"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="table_name" type="text" value="{{ target.table_name }}" maxlength="30" required></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="s3_key_prefix" type="text" value="{{ target.s3_key_prefix }}" maxlength="180" required></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="sort_keys" type="text" value="{{ target.sort_keys }}" pattern="^[,0-9]{1,}$"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="dist_style" type="text" value="{{ target.dist_style }}" pattern="^(even|all|[0-9]{1,})$"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row text-center col-md-2"><nobr>
            <a href="#" class="btn btn-default btn-sm move down" role="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></a>
            <a href="#" class="btn btn-default btn-sm move up" role="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></a>
            <a href="#" class="btn btn-default btn-sm add" role="button"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
            <a href="#" class="btn btn-default btn-sm delete" role="button"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
        </nobr></td>
    </tr>
    {% endfor %}
    {% else %}
    <tr>
        <td class="row col-md-1">
            <div class="col-md-12">
                <div class="form-group">
                    <select class="form-control select_is_master" name="is_master" require>
                        <option selected>全件</option>
                        <option>差分</option>
                    </select>
                </div>
            </div>
        </td>
        <td class="row col-md-1">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="schema_name" type="text" value="" placeholder="xxx"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="table_name" type="text" value="" placeholder="xxx_yyy" maxlength="30" required></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="s3_key_prefix" type="text" value="" maxlength="180" required placeholder="zzz"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="sort_keys" type="text" value="" pattern="^[,0-9]{1,}$" placeholder="1,2"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row col-md-2">
            <div class="col-md-12">
                <div class="form-group">
                    <input class="form-control" name="dist_style" type="text" value="" pattern="^(even|all|[0-9]{1,})$" placeholder="even"></input>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </td>
        <td class="row text-center col-md-2"><nobr>
            <a href="#" class="btn btn-default btn-sm move down" role="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></a>
            <a href="#" class="btn btn-default btn-sm move up" role="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></a>
            <a href="#" class="btn btn-default btn-sm add" role="button"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
            <a href="#" class="btn btn-default btn-sm delete" role="button"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
        </nobr></td>
    </tr>
    {% endif %}
    </tbody>
</table>
<hr>
<div class="form-group">
    <button type="submit" class="btn btn-primary validate" role=button id="submit_dag_info">更新</button>
    <a href="{{ url_for("airflow.dag_edit", dag_id=dag.dag_id) }}" class="btn btn-default" role=button>元に戻す</a>
    <a href="{{ url_for("airflow.trash", dag_id=dag.dag_id) }}" class="btn btn-danger" role=button>タスクの削除</a>
    {% if csrf_token %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="tables" value="" id="table_info"/>
    <input type="hidden" name="base_dag_id" value="{{ dag.dag_id }}"/>
    {% endif %}
</div>
</form>
{% endblock %}

{% block tail %}
{{ super() }}
    <script src="{{ url_for('static', filename='validator.min.js') }}"></script>
    <script>
     $(document).ready(function() {
         $("#editDagForm").validator();

         $('table').on('click','.delete',function(){
             $(this).parents('tr').remove();
             $("#editDagForm").validator('update');
         });

         $('table').on('click','.add',function(){
             var row = $(this).closest('tr');
             var clone = row.clone();
             clone.find(':text').val('');
             clone.find('ul').remove();
             row.after(clone)
             $("#editDagForm").validator('update');
         });

         $('table').on('click','.move',function(){
             var row = $(this).closest('tr');
             if ($(this).hasClass('up')){
                 row.prev().before(row);
             }else{
                 row.next().after(row);
             }
         });

         $('#submit_dag_info').on('click', function(){
             var info = $('#table_info_raw tbody tr').map(function() {
                 var elems = {};
                 $(this).children('td').each(function() {
                     var e = $(this).find('input:first,select:first');
                     if (e.attr('name') != null) {
                         var val = e.val();
                         if (e.hasClass('select_is_master')) {
                             val = val == '全件';
                         }
                         elems[e.attr('name')] = val;
                     }
                 });
                 return elems;
             }).get();
             var j = JSON.stringify(info);
             $("#table_info").val(j);
         });
     });
    </script>
{% endblock %}
